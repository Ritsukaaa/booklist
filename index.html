<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>作者篩選測試</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    .filters, .author-tag-row { margin-bottom: 1em; }
    select { margin-right: 10px; }
    .book-card { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
  </style>
</head>
<body>
  <h2>作者分類篩選測試頁</h2>
  <div class="filters">
    <label>評分：</label>
    <select id="rating-filter">
      <option value="">𖤐 評分</option>
      <option value="5">★★★★★</option>
      <option value="4">★★★★☆</option>
      <option value="3">★★★☆☆</option>
      <option value="2">★★☆☆☆</option>
      <option value="1">★☆☆☆☆</option>
    </select>
  </div>

  <div class="author-tag-row" id="author-tag-row"></div>

  <div id="bookList"></div>

  <script>
const authorAliasMap = {
  "明蒿": ["明蒿", "留蘅"],
  "童子": ["童子", "折一枚針"],
  "風弄": ["風弄"]
};

const authorTagCategories = ["兩個字", "三個字", "四個字"];

const bookData = [
  {
    title: "《小說A》", author: "明蒿", stars: "★★★★★", plainTags: ["兩個字"], comment: "故事精彩"
  },
  {
    title: "《小說B》", author: "留蘅", stars: "★★★☆☆", plainTags: ["兩個字"], comment: "風格冷靜"
  },
  {
    title: "《小說C》", author: "童子", stars: "★★★★☆", plainTags: ["兩個字"], comment: "文字細膩"
  },
  {
    title: "《小說D》", author: "折一枚針", stars: "★★☆☆☆", plainTags: ["四個字"], comment: "情節鬆散"
  },
  {
    title: "《小說E》", author: "風弄", stars: "★★★★☆", plainTags: ["兩個字"], comment: "經典老作"
  }
];

let currentAuthorFilter = {};
let filteredBooks = [...bookData];

function renderAuthorTagFilters() {
  const row = document.getElementById("author-tag-row");
  authorTagCategories.forEach(category => {
    const select = document.createElement("select");
    select.setAttribute("data-author-tag", category);
    select.innerHTML = `<option value="">𖤐 ${category}</option>`;

    const authors = Object.keys(authorAliasMap).filter(author =>
      bookData.find(b => b.author === author && b.plainTags?.includes(category))
    );

    authors.forEach(name => {
      const opt = document.createElement("option");
      opt.value = name;
      opt.textContent = name;
      select.appendChild(opt);
    });

    select.addEventListener("change", () => {
      currentAuthorFilter[category] = select.value;
      applyFilter();
    });

    row.appendChild(select);
  });
}

function applyFilter() {
  const ratingFilter = document.getElementById("rating-filter")?.value || "";

  filteredBooks = bookData.filter(book => {
    const ratingMatch = !ratingFilter || book.stars.startsWith("★".repeat(ratingFilter));
    const authorMatch = Object.entries(currentAuthorFilter).every(([cat, selected]) => {
      if (!selected) return true;
      return (
        book.plainTags?.includes(cat) &&
        authorAliasMap[selected]?.includes(book.author)
      );
    });
    return ratingMatch && authorMatch;
  });

  renderBooks();
}

function renderBooks() {
  const list = document.getElementById("bookList");
  list.innerHTML = "";
  filteredBooks.forEach(book => {
    const div = document.createElement("div");
    div.className = "book-card";
    div.innerHTML = `<strong>${book.title}</strong><br>作者：${book.author}<br>評分：${book.stars}<br>${book.comment}`;
    list.appendChild(div);
  });
}

document.addEventListener("DOMContentLoaded", () => {
  renderAuthorTagFilters();
  document.getElementById("rating-filter")?.addEventListener("change", applyFilter);
  applyFilter();
});
  </script>
</body>
</html>
